rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }

    function isLeagueAdmin(leagueId) {
      return isAdmin() && request.auth.token.leagueId == leagueId;
    }

    function isValidScore() {
      return request.resource.data.homeScore is int
        && request.resource.data.homeScore >= 0
        && request.resource.data.awayScore is int
        && request.resource.data.awayScore >= 0;
    }

    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if false;
    }

    match /leagues/{leagueId} {
      allow read: if true;
      allow write: if isLeagueAdmin(leagueId);

      match /teams/{teamId} {
        allow read: if true;
        allow create, update: if isLeagueAdmin(leagueId);
        allow delete: if isLeagueAdmin(leagueId);
      }

      match /players/{playerId} {
        allow read: if true;
        allow create, update: if isLeagueAdmin(leagueId);
        allow delete: if isLeagueAdmin(leagueId);
      }

      match /tournaments/{tournamentId} {
        allow read: if true;
        allow create, update: if isLeagueAdmin(leagueId);
        allow delete: if isLeagueAdmin(leagueId);

        match /matchdays/{matchdayId} {
          allow read: if true;
          allow create, update: if isLeagueAdmin(leagueId);
          allow delete: if isLeagueAdmin(leagueId);
        }

        match /matches/{matchId} {
          allow read: if true;
          allow create: if isLeagueAdmin(leagueId);
          allow update: if isLeagueAdmin(leagueId)
            && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['homeScore', 'awayScore'])
                || isValidScore());
          allow delete: if isLeagueAdmin(leagueId);
        }

        match /standings/{teamId} {
          allow read: if true;
          allow write: if false;
        }
      }
    }
  }
}
